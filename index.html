<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CV Builder</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Set default font to Inter */
        html { font-family: 'Inter', sans-serif; }
        
        /* Mobile Layout Scroll Fix: On screens smaller than 'lg' (desktop), limit the height of the input form and make it scrollable */
        @media (max-width: 1023px) {
            .input-form-scroll {
                max-height: 80vh; /* 80% of viewport height */
                overflow-y: auto;
                padding-right: 1rem; /* Add some padding for better scroll look */
            }
        }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }

            /* FIX: Force white background and zero margins on the entire page content */
            html, body {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                min-height: 100vh;
            }

            .cv-preview-container { 
                display: block !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important;
            }
            
            /* Override the desktop container padding/margins */
            .container { 
                width: 100% !important; 
                max-width: none !important; 
                margin: 0 !important; 
                padding: 0 !important;
            }
            
            /* Remove shadows for clean PDF output */
            .bg-white, .shadow-xl { box-shadow: none !important; }
            
            /* FIX: Ensure background colors print for skill badges (Android PDF fix) */
            .cv-preview-container * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* NEW FIX: Remove excessive bottom margin by resetting height and padding on the CV document itself */
            .cv-document {
                min-height: auto !important; /* Remove fixed/min height */
                height: auto !important;    /* Let content dictate height */
                padding: 24px !important;   /* Apply a uniform, small padding for print border */
                margin: 0 !important;
            }
            
            /* Ensure the bullet points print correctly */
            .cv-document ul {
                list-style-type: disc;
                padding-left: 20px;
                margin-top: 4px;
            }
            
            /* CRITICAL PRINT FIX: Ensure contact details flow naturally on print */
            .cv-contact-bar {
                display: flex !important;
                flex-wrap: wrap !important;
                /* Add sufficient gap between items in print mode to encourage wrapping */
                gap: 8px 24px !important; 
            }
            
            .cv-contact-bar > span {
                /* Give each item some room to breathe, while allowing it to shrink */
                flex-shrink: 1;
                min-width: 150px; 
            }
        }
        /* Toggle Switch Custom Styling */
        .toggle-checkbox {
            transition: transform 0.2s;
        }
        /* Tailwind JIT ensures these dynamic classes work */
        .toggle-checkbox:checked {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        
        // Map user-facing names to Tailwind color prefixes
        const colorMap = {
            'Indigo': 'indigo',
            'Blue': 'blue',
            'Green': 'green',
            'Red': 'red',
            'Grey': 'gray',
        };

        // --- Initial CV Data Structure ---
        const createEmptyPersonal = () => ({
            name: '',
            title: '',
            email: '',
            phone: '',
            linkedin: '',
            address: '',
            showAddress: true,
            showTitle: true,
            showLinkedin: true,
            primaryColor: 'indigo',
        });
        
        const createEmptyData = () => ({
            personal: createEmptyPersonal(),
            summary: '',
            experience: [],
            education: [],
            skills: '',
        });

        const createEmptyExperience = (id) => ({
          id,
          title: '',
          company: '',
          duration: '',
          description: '',
        });

        const createEmptyEducation = (id) => ({
          id,
          institution: '',
          degree: '',
          duration: '',
        });

        // NOTE: This constant holds the clean, default data structure (Example Plumber CV)
        const initialCVData = {
          personal: {
            name: 'David Johnson',
            title: 'Qualified Plumber & Heating Engineer',
            email: 'david.johnson.plumbing@example.com',
            phone: '07890 123456',
            linkedin: 'linkedin.com/in/davidjohnsonplumbing',
            address: 'Guiseley, Leeds LS20 1BG',
            showAddress: true,
            showTitle: true,
            showLinkedin: true,
            primaryColor: 'indigo', // Default color scheme
          },
          // British spelling: 'Specialised' and 'refurbishments' are used here.
          summary: 'Highly skilled and reliable Level 3 Qualified Plumber with 8 years of experience in domestic and light commercial settings. Proficient in boiler installation, fault finding, and complete bathroom refurbishments. Committed to delivering high-quality workmanship and excellent customer service.',
          experience: [
            {
              id: 1,
              title: 'Self-Employed Plumbing Contractor',
              company: 'D. Johnson Plumbing & Heating',
              duration: '2020 - Present',
              description: '• Managed all aspects of a busy independent business, including quoting, scheduling, and billing.\n• Specialised in complete domestic bathroom installations, fitting WCs, baths, showers, and associated pipework.\n• Successfully completed 150+ repair jobs per year, including leaking taps, burst pipes, and drain blockages.',
            },
            {
              id: 2,
              title: 'Apprentice Plumber',
              company: 'A&B Heating Services',
              duration: '2016 - 2020',
              description: '• Assisted lead engineers with boiler services and radiator replacements.\n• Gained practical experience in hot and cold water systems installation and maintenance.',
            },
          ],
          education: [
            {
              id: 1,
              institution: 'Leeds College of Building',
              degree: 'NVQ Level 3 Plumbing and Heating',
              duration: '2014 - 2016',
            },
            {
              id: 2,
              institution: 'Guiseley High School',
              degree: 'GCSEs (9 subjects including Maths & English)',
              duration: '2009 - 2014',
            },
          ],
          skills: 'NVQ Level 3 Plumbing, Boiler Service & Repair, Bathroom Fitting, Leak Diagnostics, Pipework Installation (Copper/Plastic), Customer Service, Health & Safety',
        };
        
        // --- Local Storage Handlers ---
        const LOCAL_STORAGE_KEY = 'cvBuilderData_v1';

        const loadCVData = () => {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Ensure new fields (like primaryColor) are present if loading old data
                    return {
                        ...initialCVData,
                        ...parsedData,
                        personal: { ...initialCVData.personal, ...parsedData.personal },
                    };
                }
            } catch (e) {
                console.error("Error loading from localStorage, using initial data.", e);
            }
            return initialCVData;
        };

        const saveCVData = (data) => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.error("Error saving to localStorage.", e);
            }
        };


        // FIX: Wrap all React application code inside window.onload to ensure React and ReactDOM CDNs are fully loaded.
        window.onload = function() {
        
            // FIX: Explicitly use window.React and window.ReactDOM to ensure the globals are accessed after CDNs load.
            // ADDED 'memo' for component memoization (the fix for the focus loss issue)
            const { useState, useCallback, useRef, forwardRef, memo } = window.React;
            const root = window.ReactDOM.createRoot(document.getElementById('root'));

            // --- Custom Components ---

            const InputField = ({ label, name, value, onChange, type = 'text', fullWidth = false, placeholder = '', colorPrefix, isInvalid = false, validationMessage = '' }) => (
              // Removed gridColumn styling from here as we manage it externally now
              <div className="mb-3"> 
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  {label}
                </label>
                <input
                  type={type}
                  name={name}
                  value={value}
                  onChange={onChange}
                  placeholder={placeholder}
                  // Dynamic focus ring and border color based on validation
                  className={`w-full p-2 border rounded-lg transition duration-150 ease-in-out ${
                    isInvalid
                      ? 'border-red-500 focus:ring-red-500 focus:border-red-500'
                      : `border-gray-300 focus:ring-${colorPrefix}-500 focus:border-${colorPrefix}-500`
                  }`}
                />
                {isInvalid && validationMessage && (
                    <p className="mt-1 text-xs text-red-500 font-medium">{validationMessage}</p>
                )}
              </div>
            );

            const TextAreaField = ({ label, name, value, onChange, fullWidth = false, rows = 3, placeholder = '', colorPrefix }) => (
              // Removed gridColumn styling from here as we manage it externally now
              <div className="mb-3">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  {label}
                </label>
                <textarea
                  name={name}
                  value={value}
                  onChange={onChange}
                  rows={rows}
                  placeholder={placeholder}
                  // Dynamic focus ring and border color
                  className={`w-full p-2 border border-gray-300 rounded-lg focus:ring-${colorPrefix}-500 focus:border-${colorPrefix}-500 transition duration-150 ease-in-out`}
                />
              </div>
            );

            const Toggle = ({ label, name, checked, onChange, colorPrefix }) => (
              // Changed col-span-2 to w-full to stop interfering with the main grid layout when used
              <div className={`flex items-center justify-between w-full mb-3 p-3 bg-${colorPrefix}-50 rounded-lg`}>
                <label htmlFor={name} className="text-sm font-medium text-gray-700 select-none">
                  {label}
                </label>
                <div className="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                  <input
                    type="checkbox"
                    name={name}
                    id={name}
                    checked={checked}
                    onChange={onChange}
                    // Dynamic border color when unchecked/checked
                    className={`toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer ${
                      checked ? `transform translate-x-full border-${colorPrefix}-600` : 'border-gray-300'
                    }`}
                    style={{
                      boxShadow: '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                    }}
                  />
                  <label
                    htmlFor={name}
                    // Dynamic background color when checked
                    className={`toggle-label block overflow-hidden h-6 rounded-full cursor-pointer ${checked ? `bg-${colorPrefix}-600` : 'bg-gray-300'}`}
                  ></label>
                </div>
              </div>
            );


            // --- CV Preview Component ---

            const CVPreview = forwardRef(({ data }, ref) => {
              const { personal, summary, experience, education, skills } = data;
              const { name, title, email, phone, linkedin, showTitle, showLinkedin, address, showAddress, primaryColor } = personal;

              const SkillPill = ({ skill }) => (
                // Dynamic background, text colors, and added subtle ring border
                <span className={`inline-block bg-${primaryColor}-100 text-${primaryColor}-800 text-xs font-semibold px-3 py-1 rounded-full ring-1 ring-${primaryColor}-200 mr-2 mb-2`}>
                  {skill.trim()}
                </span>
              );
              
              const ExperienceDescription = ({ description }) => {
                  if (!description) return <p className="text-xs text-gray-700">Key responsibilities and achievements.</p>;
                  
                  // Split by newline, filter out empty lines, and map to list items
                  const lines = description.split('\n').filter(line => line.trim().length > 0);
                  
                  if (lines.length === 0) return null;

                  return (
                      // Using an unordered list for proper CV formatting
                      <ul className="list-disc list-outside ml-5 text-xs text-gray-700">
                          {lines.map((line, index) => (
                              // Trim the bullet point character if it exists (e.g., '•' or '-')
                              <li key={index} className="mb-0.5">
                                  {line.trim().startsWith('•') || line.trim().startsWith('-') ? line.trim().substring(1).trim() : line.trim()}
                              </li>
                          ))}
                      </ul>
                  );
              };

              // Dynamic class utility function
              const getTextColor = (shade) => `text-${primaryColor}-${shade}`;
              const getBorderColor = (shade) => `border-${primaryColor}-${shade}`;

              return (
                <div
                  ref={ref}
                  // Added cv-document class for print targeting (Fixes bottom margin)
                  className="bg-white p-6 md:p-10 shadow-xl min-h-[80vh] w-full cv-document"
                >
                  {/* Header - Personal Info */}
                  {/* Dynamic border color */}
                  <header className={`border-b-4 ${getBorderColor(600)} pb-2 mb-6`}>
                    <h1 className="text-4xl font-extrabold text-gray-900 mb-1">
                      {name || 'Your Name'}
                    </h1>
                    {/* Title is shown only if showTitle is true */}
                    {showTitle && (
                        <p className={`text-xl font-semibold ${getTextColor(600)} mb-2`}>
                          {title || 'Your Professional Title'}
                        </p>
                    )}
                    
                    {/* Contact Info Layout 
                      
                      FIX: Switched from rigid grid to a flexible wrapping layout (flex flex-wrap) 
                      to ensure items flow better in the preview and wrap reliably on print.
                    */}
                    <div className="cv-contact-bar flex flex-wrap items-center text-sm text-gray-600 gap-x-6 gap-y-2">
                      
                      {/* 1. Phone */}
                      <span className="flex items-center space-x-2">
                        <i className={`fa-solid fa-square-phone ${getTextColor(600)} text-lg min-w-[20px] text-center`}></i>
                        <span className="break-all">{phone}</span>
                      </span>
                      
                      {/* 2. Address (Conditional) */}
                      {showAddress && address && (
                        <span className="flex items-center space-x-2">
                          <i className={`fa-solid fa-location-dot ${getTextColor(600)} text-lg min-w-[20px] text-center`}></i>
                          <span className="break-words">{address}</span>
                        </span>
                      )}
                      
                      {/* 3. Email */}
                      <span className="flex items-center space-x-2">
                        <i className={`fa-solid fa-square-envelope ${getTextColor(600)} text-lg min-w-[20px] text-center`}></i>
                        <span className="break-all">{email}</span>
                      </span>

                      {/* 4. LinkedIn (Conditional) */}
                      {showLinkedin && linkedin && (
                        <span className="flex items-center space-x-2">
                          <i className={`fa-brands fa-square-linkedin ${getTextColor(600)} text-lg min-w-[20px] text-center`}></i>
                          <span className="break-all">{linkedin}</span>
                        </span>
                      )}
                    </div>
                  </header>

                  {/* Summary */}
                  <section className="mb-6">
                    {/* Dynamic text colour */}
                    <h2 className={`text-lg font-bold uppercase ${getTextColor(600)} border-b border-gray-300 mb-2 pb-1`}>
                      Professional Summary
                    </h2>
                    <p className="text-gray-700 leading-relaxed text-sm">
                      {summary || 'A brief summary of your career and professional goals.'}
                    </p>
                  </section>

                  {/* Experience */}
                  <section className="mb-6">
                    {/* Dynamic text colour */}
                    <h2 className={`text-lg font-bold uppercase ${getTextColor(600)} border-b border-gray-300 mb-3 pb-1`}>
                      Work Experience
                    </h2>
                    {experience.filter(e => e.title || e.company).map((exp, index) => (
                      <div key={exp.id} className={`mb-4 ${index > 0 ? 'mt-4' : ''}`}>
                        <div className="flex justify-between items-start">
                          <h3 className="text-md font-bold text-gray-900">
                            {exp.title || 'Job Title'}
                          </h3>
                          <span className="text-sm text-gray-500 font-medium">
                            {exp.duration || '2020 - Present'}
                          </span>
                        </div>
                        {/* Dynamic text colour */}
                        <p className={`text-sm ${getTextColor(600)} font-medium italic mb-1`}>
                          {exp.company || 'Company Name'}
                        </p>
                        {/* Replaced p tag with custom ExperienceDescription component for proper bullets */}
                        <ExperienceDescription description={exp.description} />
                      </div>
                    ))}
                  </section>

                  {/* Education */}
                  <section className="mb-6">
                    {/* Dynamic text colour */}
                    <h2 className={`text-lg font-bold uppercase ${getTextColor(600)} border-b border-gray-300 mb-3 pb-1`}>
                      Education
                    </h2 >
                    {education.filter(e => e.degree || e.institution).map(edu => (
                      <div key={edu.id} className="mb-2">
                        <div className="flex justify-between items-start">
                          <h3 className="text-md font-bold text-gray-900">
                            {edu.degree || 'Degree/Major'}
                          </h3>
                          <span className="text-sm text-gray-500 font-medium">
                            {edu.duration || '2016 - 2020'}
                          </span>
                        </div>
                        {/* Dynamic text colour */}
                        <p className={`text-sm ${getTextColor(600)} font-medium italic`}>
                          {edu.institution || 'University Name'}
                        </p>
                      </div>
                    ))}
                  </section>

                  {/* Skills */}
                  <section>
                    {/* Dynamic text colour */}
                    <h2 className={`text-lg font-bold uppercase ${getTextColor(600)} border-b border-gray-300 mb-3 pb-1`}>
                      Skills & Technologies
                    </h2 >
                    <div className="flex flex-wrap gap-1">
                      {skills
                        .split(',')
                        .filter(s => s.trim().length > 0)
                        .map((skill, index) => (
                          <SkillPill key={index} skill={skill} />
                        ))}
                    </div>
                  </section>
                </div>
              );
            });

            // --- Item Movement/Edit Wrapper Component ---
            
            // FIX: Wrapping with React.memo to prevent unnecessary re-renders of sibling items
            // which was causing the input fields to be unmounted and remounted, losing focus.
            const ArrayItemEditor = memo(({ section, item, children, index, total, handleMove, handleRemoveSection }) => {
                const isMovable = total > 1;
                const isFirst = index === 0;
                const isLast = index === total - 1;

                return (
                  <div
                    // NOTE: Key is passed in by the parent map function, not defined here
                    className={`p-4 mb-4 border rounded-lg bg-gray-50 relative border-gray-200 transition-all duration-200 ease-in-out hover:bg-gray-100`}
                  >
                      {/* Action Buttons Container */}
                      <div className="absolute top-2 right-2 flex space-x-1 z-10">
                          {isMovable && (
                              <>
                                  {/* Move Down Button */}
                                  <button
                                      onClick={() => handleMove(section, item.id, 'down')}
                                      disabled={isLast}
                                      className={`text-gray-500 p-1 rounded-full text-lg leading-none transition duration-150 ${isLast ? 'opacity-30 cursor-not-allowed' : 'hover:bg-gray-200 hover:text-gray-700'}`}
                                      title={`Move ${section.slice(0, -1)} Down`}
                                      aria-label={`Move item ${index + 1} down`}
                                  >
                                      <i className="fa-solid fa-circle-down text-lg"></i>
                                  </button>
                                  {/* Move Up Button */}
                                  <button
                                      onClick={() => handleMove(section, item.id, 'up')}
                                      disabled={isFirst}
                                      className={`text-gray-500 p-1 rounded-full text-lg leading-none transition duration-150 ${isFirst ? 'opacity-30 cursor-not-allowed' : 'hover:bg-gray-200 hover:text-gray-700'}`}
                                      title={`Move ${section.slice(0, -1)} Up`}
                                      aria-label={`Move item ${index + 1} up`}
                                  >
                                      <i className="fa-solid fa-circle-up text-lg"></i>
                                  </button>
                              </>
                          )}

                          {/* Remove Button */}
                          <button
                              onClick={() => handleRemoveSection(section, item.id)}
                              className="text-red-500 hover:text-red-700 p-1 rounded-full text-lg leading-none transition duration-150 hover:bg-red-100"
                              title={`Remove ${section.slice(0, -1)}`}
                              aria-label={`Remove item ${index + 1}`}
                          >
                              <i className="fa-solid fa-circle-xmark text-lg"></i>
                          </button>
                      </div>
                      
                      {/* Content Area */}
                      <div className="pt-2">
                          {children}
                      </div>
                  </div>
                );
            });

            // --- Main Application Component ---

            function App() {
              const [cvData, setCvData] = useState(loadCVData);
              const [isSaving, setIsSaving] = useState(false);
              const previewRef = useRef(null);
              const debounceTimeoutRef = useRef(null);
              
              const primaryColorPrefix = cvData.personal.primaryColor;

              // Helper to validate fields
              const validateField = (name, value) => {
                  if (name === 'name' && value.trim() === '') return 'Name is required.';
                  // Basic email validation
                  if (name === 'email' && !/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(value)) return 'Must be a valid email address.';
                  return null; // Null means valid
              };

              const handleSave = useCallback((dataToSave) => {
                setIsSaving(true); 
                
                if (debounceTimeoutRef.current) {
                    clearTimeout(debounceTimeoutRef.current);
                }

                debounceTimeoutRef.current = setTimeout(() => {
                    saveCVData(dataToSave);
                    setIsSaving(false); 
                }, 500);
              }, []);


              // --- Reset Handlers ---
              
              const handleReset = () => {
                  // NOTE: window.confirm is used here for simplicity as the environment permits it for critical actions
                  if (window.confirm("Are you sure you want to reset all data to the example plumber CV? This action cannot be undone.")) {
                      // Create a fresh deep copy of the initial data
                      const initialDataCopy = JSON.parse(JSON.stringify(initialCVData));
                      setCvData(initialDataCopy);
                      handleSave(initialDataCopy); // Save the reset state to localStorage
                  }
              };
              
              const handleClear = () => {
                  // NOTE: window.confirm is used here for simplicity as the environment permits it for critical actions
                  if (window.confirm("Are you sure you want to CLEAR all data? This will leave all fields blank.")) {
                      const emptyData = createEmptyData();
                      setCvData(emptyData);
                      handleSave(emptyData); // Save the empty state to localStorage
                  }
              };

              // --- Input Handlers ---

              const handlePersonalChange = (e) => {
                const { name, value, type, checked } = e.target;
                const newValue = type === 'checkbox' ? checked : value;

                const newData = {
                  ...cvData,
                  personal: { ...cvData.personal, [name]: newValue },
                };
                setCvData(newData);
                handleSave(newData);
              };
              
              const handleColorChange = (colorKey) => {
                 const newData = {
                  ...cvData,
                  personal: { ...cvData.personal, primaryColor: colorKey },
                };
                setCvData(newData);
                handleSave(newData);
              }


              const handleSummaryAndSkillsChange = (e) => {
                const { name, value } = e.target;
                const newData = { ...cvData, [name]: value };
                setCvData(newData);
                handleSave(newData);
              };

              // FIX: Wrapped handleArrayChange with useCallback to ensure stability when passed to memoized ArrayItemEditor
              const handleArrayChange = useCallback((section, id, name, value) => {
                // Use functional update form of setState to get the latest state reliably
                setCvData(prevCvData => {
                    const updatedArray = prevCvData[section].map((item) =>
                        item.id === id ? { ...item, [name]: value } : item
                    );
                    const newData = { ...prevCvData, [section]: updatedArray };
                    // Save the new state
                    handleSave(newData); 
                    return newData;
                });
              }, [handleSave]); // handleSave is stable (using useCallback)

              const handleAddSection = (section, emptyCreator) => {
                const newId = Date.now() + Math.random();
                const newSection = emptyCreator(newId);
                const newData = {
                  ...cvData,
                  [section]: [...cvData[section], newSection],
                };
                setCvData(newData);
                handleSave(newData);
              };

              const handleRemoveSection = (section, id) => {
                const updatedArray = cvData[section].filter((item) => item.id !== id);
                const newData = { ...cvData, [section]: updatedArray };
                setCvData(newData);
                handleSave(newData);
              };

              const handlePrint = () => {
                window.print();
              };
              
              // --- Item Movement Handler (REPLACEMENT FOR DRAG/DROP) ---
              const handleMove = (section, id, direction) => {
                  const items = [...cvData[section]];
                  const index = items.findIndex(item => item.id === id);

                  if (index === -1) return;

                  const newIndex = direction === 'up' ? index - 1 : index + 1;

                  // Check bounds
                  if (newIndex < 0 || newIndex >= items.length) return;

                  // Swap items using array destructuring
                  [items[index], items[newIndex]] = [items[newIndex], items[index]];

                  const newData = { ...cvData, [section]: items };
                  setCvData(newData);
                  handleSave(newData);
              };


              return (
                <div className="min-h-screen bg-gray-50 font-sans">
                  <div className="container mx-auto px-4 py-8">
                    {/* These are hidden on print using the 'no-print' class */}
                    <h1 className="text-3xl font-extrabold text-gray-900 mb-2 no-print">
                      CV Builder
                    </h1>
                    <p className="text-sm text-gray-600 mb-6 no-print">
                      Create your personal CV for free!
                    </p>

                    {/* Main Layout: Now using 50/50 split (lg:grid-cols-2) on Desktop */}
                    <div className="lg:grid lg:grid-cols-2 lg:gap-8">
                      {/* Input Form - Added input-form-scroll class for mobile height constraint */}
                      <div className="lg:col-span-1 no-print bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 lg:mb-0 input-form-scroll">
                        <div className="flex justify-between items-center mb-6 flex-wrap gap-y-2">
                            <h2 className="text-2xl font-bold text-gray-800">Edit Your Details</h2>
                            <div className="relative flex space-x-2">
                                {/* Clear Button */}
                                <button
                                    onClick={handleClear}
                                    className={`bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm`}
                                    aria-label="Clear All Data"
                                >
                                    Clear All
                                </button>
                                {/* Reset Button */}
                                <button
                                    onClick={handleReset}
                                    className={`bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm`}
                                    aria-label="Reset Data"
                                >
                                    Reset to Example
                                </button>
                            </div>
                        </div>
                        
                        {/* Colour Selector (Updated for British English) */}
                        <div className="mb-8 border-b pb-4">
                          {/* British English Spelling for Colour Scheme */}
                            <h3 className="text-xl font-semibold text-gray-700 mb-4">
                                Colour Scheme
                            </h3>
                            <div className="flex space-x-3">
                                {Object.entries(colorMap).map(([name, prefix]) => (
                                    <button
                                        key={prefix}
                                        onClick={() => handleColorChange(prefix)}
                                        // Reduced size from w-10 h-10 to w-8 h-8
                                        className={`w-8 h-8 rounded-full transition duration-150 ease-in-out shadow-md
                                                    bg-${prefix}-600 
                                                    ${primaryColorPrefix === prefix ? `ring-4 ring-offset-2 ring-${prefix}-600` : 'hover:opacity-80'}`}
                                        title={`Use ${name} theme`}
                                        aria-pressed={primaryColorPrefix === prefix}
                                    ></button>
                                ))}
                            </div>
                        </div>


                        {/* Personal Information */}
                        <div className="mb-8 border-b pb-4">
                          {/* Dynamic colour in header */}
                          <h3 className={`text-xl font-semibold text-${primaryColorPrefix}-600 mb-4`}>
                            Personal Information
                          </h3>
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            
                            {/* Full Name & Email (Pair 1) */}
                            <InputField
                              label="Full Name *"
                              name="name"
                              value={cvData.personal.name}
                              onChange={handlePersonalChange}
                              placeholder="David Johnson"
                              colorPrefix={primaryColorPrefix}
                              isInvalid={validateField('name', cvData.personal.name) !== null}
                              validationMessage={validateField('name', cvData.personal.name)}
                            />
                            <InputField
                              label="Email *"
                              name="email"
                              type="email"
                              value={cvData.personal.email}
                              onChange={handlePersonalChange}
                              placeholder="your.email@example.com"
                              colorPrefix={primaryColorPrefix}
                              isInvalid={validateField('email', cvData.personal.email) !== null}
                              validationMessage={validateField('email', cvData.personal.email)}
                            />
                            
                            {/* Phone Number (Full width on mobile, half on desktop) */}
                            <InputField
                              label="Phone Number"
                              name="phone"
                              value={cvData.personal.phone}
                              onChange={handlePersonalChange}
                              placeholder="07890 123456"
                              colorPrefix={primaryColorPrefix}
                            />
                            
                            {/* Spacer to align Phone to the left when on desktop */}
                            <div className="hidden md:block"></div> 


                            {/* Professional Title Toggle & Input */}
                            <div className="col-span-1 md:col-span-2">
                                <Toggle
                                    label="Show Professional Title"
                                    name="showTitle"
                                    checked={cvData.personal.showTitle}
                                    onChange={handlePersonalChange}
                                    colorPrefix={primaryColorPrefix}
                                />
                                {cvData.personal.showTitle && (
                                    // Use an inner grid for the input when displayed
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <InputField
                                          label="Professional Title"
                                          name="title"
                                          value={cvData.personal.title}
                                          onChange={handlePersonalChange}
                                          placeholder="Qualified Plumber"
                                          colorPrefix={primaryColorPrefix}
                                        />
                                    </div>
                                )}
                            </div>


                            {/* LinkedIn Toggle & Input */}
                            <div className="col-span-1 md:col-span-2">
                                <Toggle
                                    label="Show LinkedIn URL"
                                    name="showLinkedin"
                                    checked={cvData.personal.showLinkedin}
                                    onChange={handlePersonalChange}
                                    colorPrefix={primaryColorPrefix}
                                />
                                {cvData.personal.showLinkedin && (
                                    // Use an inner grid for the input when displayed
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <InputField
                                          label="LinkedIn URL"
                                          name="linkedin"
                                          value={cvData.personal.linkedin}
                                          onChange={handlePersonalChange}
                                          placeholder="linkedin.com/in/yourname"
                                          colorPrefix={primaryColorPrefix}
                                        />
                                    </div>
                                )}
                            </div>
                            
                            
                            {/* Address Toggle & Input (Always full width on both mobile/desktop for inputs like this) */}
                            <div className="col-span-1 md:col-span-2">
                                <Toggle
                                    label="Show Full Address"
                                    name="showAddress"
                                    checked={cvData.personal.showAddress}
                                    onChange={handlePersonalChange}
                                    colorPrefix={primaryColorPrefix}
                                />
                                {cvData.personal.showAddress && (
                                    <InputField
                                      label="Address (City, Postcode)"
                                      name="address"
                                      value={cvData.personal.address}
                                      onChange={handlePersonalChange}
                                      placeholder="Guiseley, Leeds LS20 1BG"
                                      fullWidth={true} /* Span across both columns */
                                      colorPrefix={primaryColorPrefix}
                                    />
                                )}
                            </div>
                            
                          </div>
                        </div>

                        {/* Summary */}
                        <div className="mb-8 border-b pb-4">
                          <h3 className={`text-xl font-semibold text-${primaryColorPrefix}-600 mb-4`}>
                            Professional Summary
                          </h3>
                          <TextAreaField
                            label="Summary"
                            name="summary"
                            value={cvData.summary}
                            onChange={handleSummaryAndSkillsChange}
                            rows={4}
                            placeholder="Write a compelling, short paragraph about your career goals and achievements."
                            fullWidth
                            colorPrefix={primaryColorPrefix}
                          />
                        </div>

                        {/* Work Experience */}
                        <div className="mb-8 border-b pb-4">
                          <h3 className={`text-xl font-semibold text-${primaryColorPrefix}-600 mb-4`}>
                            Work Experience
                          </h3>
                          {cvData.experience.map((exp, index) => (
                            <ArrayItemEditor 
                                key={exp.id} // The key is correct here
                                section="experience" 
                                item={exp} 
                                index={index}
                                total={cvData.experience.length}
                                handleMove={handleMove}
                                handleRemoveSection={handleRemoveSection}
                            >
                                {/* FIX: Changed grid-cols-2 to grid-cols-1 md:grid-cols-2 */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <InputField
                                    name="title"
                                    label="Job Title"
                                    value={exp.title}
                                    onChange={(e) => handleArrayChange('experience', exp.id, e.target.name, e.target.value)}
                                    placeholder="e.g., Plumbing Contractor"
                                    colorPrefix={primaryColorPrefix}
                                    />
                                    <InputField
                                    name="company"
                                    label="Company"
                                    value={exp.company}
                                    onChange={(e) => handleArrayChange('experience', exp.id, e.target.name, e.target.value)}
                                    placeholder="e.g., D. Johnson Plumbing & Heating"
                                    colorPrefix={primaryColorPrefix}
                                    />
                                    <InputField
                                    name="duration"
                                    label="Duration"
                                    value={exp.duration}
                                    onChange={(e) => handleArrayChange('experience', exp.id, e.target.name, e.target.value)}
                                    placeholder="e.g., 2020 - Present"
                                    colorPrefix={primaryColorPrefix}
                                    />
                                    {/* Description field always takes full width */}
                                    <div className="col-span-1 md:col-span-2">
                                        <TextAreaField
                                            label="Description (One bullet point per line)"
                                            name="description"
                                            value={exp.description}
                                            onChange={(e) => handleArrayChange('experience', exp.id, e.target.name, e.target.value)}
                                            rows={4}
                                            // Updated placeholder text for clarity
                                            placeholder="Enter one bullet point per line. Example:&#10;• Managed all aspects of the business&#10;• Specialised in bathroom fitting"
                                            colorPrefix={primaryColorPrefix}
                                        />
                                    </div>
                                </div>
                            </ArrayItemEditor>
                          ))}
                          <button
                            onClick={() => handleAddSection('experience', createEmptyExperience)}
                            className={`w-full bg-${primaryColorPrefix}-100 text-${primaryColorPrefix}-700 font-semibold py-2 rounded-lg hover:bg-${primaryColorPrefix}-200 transition duration-150 ease-in-out mt-2`}
                          >
                            + Add Experience
                          </button>
                        </div>

                        {/* Education */}
                        <div className="mb-8 border-b pb-4">
                          <h3 className={`text-xl font-semibold text-${primaryColorPrefix}-600 mb-4`}>
                            Education
                          </h3>
                          {cvData.education.map((edu, index) => (
                            <ArrayItemEditor 
                                key={edu.id} // The key is correct here
                                section="education" 
                                item={edu} 
                                index={index}
                                total={cvData.education.length}
                                handleMove={handleMove}
                                handleRemoveSection={handleRemoveSection}
                            >
                                {/* FIX: Changed grid-cols-2 to grid-cols-1 md:grid-cols-2 */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <InputField
                                    label="Degree/Qualification"
                                    name="degree"
                                    value={edu.degree}
                                    onChange={(e) => handleArrayChange('education', edu.id, e.target.name, e.target.value)}
                                    placeholder="e.g., NVQ Level 3 Plumbing"
                                    colorPrefix={primaryColorPrefix}
                                    />
                                    <InputField
                                    label="Institution"
                                    name="institution"
                                    value={edu.institution}
                                    onChange={(e) => handleArrayChange('education', edu.id, e.target.name, e.target.value)}
                                    placeholder="e.g., Leeds College of Building"
                                    colorPrefix={primaryColorPrefix}
                                    />
                                    <InputField
                                    label="Duration"
                                    name="duration"
                                    value={edu.duration}
                                    onChange={(e) => handleArrayChange('education', edu.id, e.target.name, e.target.value)}
                                    placeholder="e.g., 2014 - 2016"
                                    colorPrefix={primaryColorPrefix}
                                    />
                                </div>
                            </ArrayItemEditor>
                          ))}
                          <button
                            onClick={() => handleAddSection('education', createEmptyEducation)}
                            className={`w-full bg-${primaryColorPrefix}-100 text-${primaryColorPrefix}-700 font-semibold py-2 rounded-lg hover:bg-${primaryColorPrefix}-200 transition duration-150 ease-in-out mt-2`}
                          >
                            + Add Education
                          </button>
                        </div>

                        {/* Skills */}
                        <div className="pb-4">
                          <h3 className={`text-xl font-semibold text-${primaryColorPrefix}-600 mb-4`}>
                            Skills
                          </h3>
                          <TextAreaField
                            label="Technical Skills (Comma-separated list)"
                            name="skills"
                            value={cvData.skills}
                            onChange={handleSummaryAndSkillsChange}
                            rows={2}
                            placeholder="e.g., NVQ Level 3 Plumbing, Boiler Service & Repair, Bathroom Fitting"
                            fullWidth
                            colorPrefix={primaryColorPrefix}
                          />
                        </div>
                        
                        {/* Print Button (Moved to bottom and made full width) */}
                        <div className="pt-6 border-t mt-6">
                            <button
                                onClick={handlePrint}
                                className={`w-full bg-${primaryColorPrefix}-600 hover:bg-${primaryColorPrefix}-700 text-white font-bold py-3 rounded-lg shadow-xl transition duration-150 ease-in-out text-lg`}
                                aria-label="Print CV"
                            >
                                <i className="fa-solid fa-print mr-2"></i>
                                Generate PDF / Print CV
                            </button>
                        </div>


                      </div>

                      {/* CV Preview - Visible on all devices (now 50% width on desktop) */}
                      <div className="lg:col-span-1 cv-preview-container">
                        {/* Live Preview Header with Indicator (NEW) */}
                        <div className="flex justify-between items-center mb-4 no-print">
                            <h2 className="text-2xl font-bold text-gray-800 lg:block hidden">Live Preview</h2>
                            {/* Live Indicator (NEW) */}
                            {isSaving && (
                                <span className={`text-sm font-medium flex items-center text-${primaryColorPrefix}-600 animate-pulse`}>
                                    <i className="fa-solid fa-spinner fa-spin mr-2"></i>
                                    Updating...
                                </span>
                            )}
                        </div>
                        <div className="sticky top-8">
                            <CVPreview data={cvData} ref={previewRef} />
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              );
            }
            
            root.render(<App />);
        };
    </script>
</body>
</html>
